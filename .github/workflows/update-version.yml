name: Update Version Info

on:
  push:
    branches:
      - master
      - main

jobs:
  update-version:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Get commit info
      id: commit
      run: |
        echo "hash=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "date=$(TZ=Asia/Tokyo date +'%Y.%m.%d-%H%M')" >> $GITHUB_OUTPUT
    
    - name: Update version.js
      run: |
        cat > HIIT_exercise_time_keeper/version.js << EOF
        // バージョン情報を動的に設定
        window.APP_VERSION = {
            build: '${{ steps.commit.outputs.date }}-${{ steps.commit.outputs.hash }}',
            timestamp: '$(date -u +"%Y-%m-%dT%H:%M:%SZ")'
        };
        EOF
    
    - name: Commit and push if changed
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add -A
        git diff --staged --quiet || (git commit -m "chore: update version info [skip ci]" && git push)